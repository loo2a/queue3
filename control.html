<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen" dir="rtl">

<nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
  <select id="myClinicSelect" class="text-gray-800 px-3 py-2 rounded-lg font-bold"></select>
</nav>

<div class="container mx-auto p-6 grid md:grid-cols-2 gap-6">

  <!-- ÙŠØ³Ø§Ø±: Ø§Ù„ØªØ­ÙƒÙ… -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-bold mb-4">Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <div class="flex gap-3 mb-4">
      <button id="btnNext" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button id="btnPrev" class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="btnRepeat" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg font-bold hover:bg-yellow-600">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>
    <div class="flex gap-2">
      <input id="customNum" type="number" placeholder="Ø±Ù‚Ù… Ù…Ø®ØµØµ" class="flex-1 p-3 border rounded-lg">
      <button id="btnCustom" class="bg-green-600 text-white px-4 rounded-lg hover:bg-green-700">Ù†Ø¯Ø§Ø¡</button>
    </div>
    <hr class="my-4">
    <div class="flex gap-2">
      <input id="alertMsg" type="text" placeholder="Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡" class="flex-1 p-3 border rounded-lg">
      <select id="targetClinic" class="p-3 border rounded-lg"></select>
      <button id="btnAlert" class="bg-red-600 text-white px-4 rounded-lg hover:bg-red-700">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„ØªØ­ÙˆÙŠÙ„ -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-bold mb-4">ØªØ­ÙˆÙŠÙ„ Ù…Ø±ÙŠØ¶</h2>
    <div class="grid grid-cols-2 gap-3 mb-3">
      <input id="transferNum" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" class="p-3 border rounded-lg">
      <select id="toClinic" class="p-3 border rounded-lg"></select>
    </div>
    <button id="btnTransfer" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">ØªØ­ÙˆÙŠÙ„ ÙÙˆØ±ÙŠ</button>
  </div>

</div>

<!-- Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø© -->
<div id="incomingAlert" class="hidden fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl max-w-sm">
  <div class="font-bold mb-1">ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ø±Ø¯</div>
  <div id="alertContent"></div>
  <button onclick="document.getElementById('incomingAlert').classList.add('hidden')" class="mt-2 text-xs underline">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script src="js/firebase-config.js"></script>
<script>
  let myClinic = null;
  let clinics = [];

  async function loadClinics(){
    const res = await window.storage.get('clinic-list');
    clinics = res?.value ? (typeof res.value==='string'?JSON.parse(res.value):res.value) : [];
    populateSelects();
  }
  function populateSelects(){
    const html = clinics.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    ['myClinicSelect','targetClinic','toClinic'].forEach(id=>document.getElementById(id).innerHTML=html);
    myClinic = clinics[0];
    document.getElementById('myClinicSelect').value = myClinic.id;
  }
  document.getElementById('myClinicSelect').onchange = e=>{
    myClinic = clinics.find(c=>c.id==e.target.value);
  };

  // Ù†Ø¯Ø§Ø¡
  async function call(num){
    const callData = {clinicId:myClinic.id, clinicName:myClinic.name, ticketNumber:num, timestamp:Date.now()};
    await window.storage.set('current-call', JSON.stringify(callData), true);
    myClinic.currentTicket = num;
    await window.storage.set('clinic-list', JSON.stringify(clinics));
  }
  document.getElementById('btnNext').onclick = ()=> call((myClinic.currentTicket||0)+1);
  document.getElementById('btnPrev').onclick = ()=> call(Math.max(0,(myClinic.currentTicket||0)-1));
  document.getElementById('btnRepeat').onclick = ()=> call(myClinic.currentTicket||0);
  document.getElementById('btnCustom').onclick = ()=>{
    const n = parseInt(document.getElementById('customNum').value);
    if(n) call(n);
  };

  // ØªÙ†Ø¨ÙŠÙ‡ Ø¨ÙŠÙ† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª
  document.getElementById('btnAlert').onclick = async ()=>{
    const msg = document.getElementById('alertMsg').value.trim();
    const targetId = document.getElementById('targetClinic').value;
    if(!msg) return;
    await window.storage.set(`alert-${targetId}`, {from:myClinic.name, msg, ts:Date.now()}, true);
    document.getElementById('alertMsg').value='';
  };
  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡
  setInterval(async()=>{
    const key = `alert-${myClinic.id}`;
    const res = await window.storage.get(key, true);
    if(res?.value){
      const d = typeof res.value==='string'?JSON.parse(res.value):res.value;
      document.getElementById('alertContent').innerHTML = `<div class="font-semibold">${d.from}</div><div>${d.msg}</div>`;
      document.getElementById('incomingAlert').classList.remove('hidden');
      await window.storage.delete(key, true);
    }
  },1000);

  // ØªØ­ÙˆÙŠÙ„ Ù…Ø±ÙŠØ¶
  document.getElementById('btnTransfer').onclick = async ()=>{
    const num = parseInt(document.getElementById('transferNum').value);
    const toId = document.getElementById('toClinic').value;
    if(!num) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶');
    const toClinic = clinics.find(c=>c.id==toId);
    const callData = {clinicId:toId, clinicName:toClinic.name, ticketNumber:num, timestamp:Date.now(), transfer:true, from:myClinic.name};
    await window.storage.set('current-call', JSON.stringify(callData), true);
    toClinic.currentTicket = num;
    await window.storage.set('clinic-list', JSON.stringify(clinics));
    document.getElementById('transferNum').value='';
  };

  loadClinics();
</script>
</body>
</html>
