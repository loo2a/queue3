<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طباعة التذاكر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #printArea, #printArea * {
                visibility: visible;
            }
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                height: 297mm;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .ticket {
            width: 5cm;
            height: 5cm;
            border: 2px solid #000;
            page-break-inside: avoid;
        }
        
        #printArea {
            width: 210mm;
            min-height: 297mm;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6" dir="rtl">
    <div class="no-print">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">طباعة تذاكر المرضى</h1>
            <p class="text-gray-600">اختر العيادة ونطاق الأرقام للطباعة</p>
        </div>

        <!-- Clinic Selection -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">اختيار العيادة</h2>
            <div id="clinicButtons" class="grid md:grid-cols-3 gap-4">
                <!-- Clinic buttons will be inserted here -->
            </div>
        </div>

        <!-- Print Settings -->
        <div id="printSettings" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">إعدادات الطباعة</h2>
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 font-semibold">من رقم</label>
                    <input type="number" id="startNumber" value="1" min="1" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block mb-2 font-semibold">إلى رقم</label>
                    <input type="number" id="endNumber" value="20" min="1" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2 font-semibold">العملاء الحاليون قبلك</label>
                <input type="number" id="waitingCount" value="0" min="0" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                <p class="text-sm text-gray-600 mt-1">عدد العملاء المنتظرين حالياً</p>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2 font-semibold">متوسط وقت الانتظار لكل عميل (دقائق)</label>
                <input type="number" id="avgWaitTime" value="5" min="1" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>

            <div class="flex gap-4">
                <button onclick="generateTickets()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                    إنشاء التذاكر
                </button>
                <button onclick="printTickets()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
                    طباعة
                </button>
                <button onclick="clearTickets()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition">
                    مسح
                </button>
            </div>
        </div>

        <!-- Preview -->
        <div id="previewSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">معاينة التذاكر</h2>
            <p class="text-gray-600 mb-4">سيتم طباعة <span id="ticketCount" class="font-bold text-blue-600">0</span> تذكرة</p>
        </div>
    </div>

    <!-- Print Area (A4 Page) -->
    <div id="printArea" class="bg-white mx-auto" style="width: 210mm;">
        <div id="ticketsContainer" class="grid grid-cols-4 gap-0 p-4">
            <!-- Tickets will be generated here -->
        </div>
    </div>

    <script>
        let selectedClinic = null;
        let clinics = [];

        // Load clinics
        async function loadClinics() {
            try {
                const result = await window.storage.get('clinic-list');
                if (result) {
                    clinics = JSON.parse(result.value);
                    renderClinicButtons();
                }
            } catch (error) {
                console.error('Error loading clinics:', error);
            }
        }

        // Render clinic buttons
        function renderClinicButtons() {
            const container = document.getElementById('clinicButtons');
            container.innerHTML = '';
            
            clinics.forEach(clinic => {
                const button = document.createElement('button');
                button.className = 'bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg hover:from-blue-600 hover:to-blue-700 transition shadow-lg transform hover:scale-105';
                button.innerHTML = `
                    <div class="text-2xl font-bold mb-2">${clinic.name}</div>
                    <div class="text-lg">عيادة رقم ${clinic.number}</div>
                `;
                button.onclick = () => selectClinic(clinic);
                container.appendChild(button);
            });
        }

        // Select clinic
        function selectClinic(clinic) {
            selectedClinic = clinic;
            document.getElementById('printSettings').classList.remove('hidden');
            
            // Highlight selected
            const buttons = document.querySelectorAll('#clinicButtons button');
            buttons.forEach(btn => {
                btn.classList.remove('ring-4', 'ring-yellow-400');
            });
            event.target.closest('button').classList.add('ring-4', 'ring-yellow-400');
        }

        // Calculate wait time
        function calculateWaitTime(ticketNumber) {
            const waitingBefore = parseInt(document.getElementById('waitingCount').value) || 0;
            const avgTime = parseInt(document.getElementById('avgWaitTime').value) || 5;
            const position = ticketNumber + waitingBefore;
            const minutes = position * avgTime;
            
            if (minutes < 60) {
                return `${minutes} دقيقة`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours} ساعة${mins > 0 ? ` و ${mins} دقيقة` : ''}`;
            }
        }

        // Generate tickets
        function generateTickets() {
            if (!selectedClinic) {
                alert('يرجى اختيار العيادة أولاً');
                return;
            }

            const start = parseInt(document.getElementById('startNumber').value);
            const end = parseInt(document.getElementById('endNumber').value);
            
            if (start > end) {
                alert('رقم البداية يجب أن يكون أقل من رقم النهاية');
                return;
            }

            const container = document.getElementById('ticketsContainer');
            container.innerHTML = '';

            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            for (let i = start; i <= end; i++) {
                const ticket = document.createElement('div');
                ticket.className = 'ticket flex flex-col justify-between p-3 bg-white';
                
                const waitTime = calculateWaitTime(i);
                const waitingBefore = parseInt(document.getElementById('waitingCount').value) || 0;
                
                ticket.innerHTML = `
                    <div class="text-center border-b-2 border-dashed pb-2 mb-2">
                        <div class="text-sm font-bold text-blue-800">${selectedClinic.name}</div>
                        <div class="text-xs text-gray-600">${currentDate}</div>
                    </div>
                    
                    <div class="flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-xs text-gray-600 mb-1">رقمك</div>
                            <div class="text-6xl font-bold text-blue-900">${i}</div>
                        </div>
                    </div>
                    
                    <div class="text-center border-t-2 border-dashed pt-2 mt-2">
                        <div class="text-xs text-gray-700">
                            <div class="font-semibold mb-1">وقت الانتظار المتوقع</div>
                            <div class="text-blue-600 font-bold">${waitTime}</div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            ${waitingBefore > 0 ? `عدد المنتظرين: ${waitingBefore + i}` : ''}
                        </div>
                    </div>
                    
                    <div class="text-center mt-2">
                        <div class="text-xs text-gray-500">نتمنى لكم السلامة</div>
                    </div>
                `;
                
                container.appendChild(ticket);
            }

            document.getElementById('ticketCount').textContent = end - start + 1;
            document.getElementById('previewSection').classList.remove('hidden');
        }

        // Print tickets
        function printTickets() {
            const container = document.getElementById('ticketsContainer');
            if (container.children.length === 0) {
                alert('يرجى إنشاء التذاكر أولاً');
                return;
            }

            window.print();
        }

        // Clear tickets
        function clearTickets() {
            if (confirm('هل تريد مسح جميع التذاكر؟')) {
                document.getElementById('ticketsContainer').innerHTML = '';
                document.getElementById('previewSection').classList.add('hidden');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            loadClinics();
        });
    </script>
</body>
</html>
