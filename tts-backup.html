<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #printArea, #printArea * {
                visibility: visible;
            }
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                height: 297mm;
            }
            .no-print {
                display: none !important;
            }
            .ticket {
                page-break-inside: avoid;
            }
        }
        
        .ticket {
            width: 5cm;
            height: 5cm;
            border: 2px solid #000;
            page-break-inside: avoid;
        }
        
        #printArea {
            width: 210mm;
            min-height: 297mm;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6" dir="rtl">
    <div class="no-print">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-800 mb-2">Ø·Ø¨Ø§Ø¹Ø© ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø±Ø¶Ù‰</h1>
                    <p class="text-gray-600">Ø§Ø®ØªØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</p>
                </div>
                <a href="index.html" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    Ø§Ù„Ø¹ÙˆØ¯Ø©
                </a>
            </div>
        </div>

        <!-- Clinic Selection -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h2>
            <div id="clinicButtons" class="grid md:grid-cols-3 gap-4">
                <!-- Clinic buttons will be inserted here -->
            </div>
        </div>

        <!-- Print Settings -->
        <div id="printSettings" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 font-semibold">Ù…Ù† Ø±Ù‚Ù…</label>
                    <input type="number" id="startNumber" value="1" min="1" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block mb-2 font-semibold">Ø¥Ù„Ù‰ Ø±Ù‚Ù…</label>
                    <input type="number" id="endNumber" value="20" min="1" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2 font-semibold">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ† Ù‚Ø¨Ù„Ùƒ</label>
                <input type="number" id="waitingCount" value="0" min="0" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                <p class="text-sm text-gray-600 mt-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2 font-semibold">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                <input type="number" id="avgWaitTime" value="5" min="1" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>

            <div class="flex gap-4">
                <button onclick="generateTickets()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°Ø§ÙƒØ±
                </button>
                <button onclick="printTickets()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
                    Ø·Ø¨Ø§Ø¹Ø©
                </button>
                <button onclick="clearTickets()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition">
                    Ù…Ø³Ø­
                </button>
            </div>
        </div>

        <!-- Preview -->
        <div id="previewSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</h2>
            <p class="text-gray-600 mb-4">Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© <span id="ticketCount" class="font-bold text-blue-600">0</span> ØªØ°ÙƒØ±Ø©</p>
        </div>
    </div>

    <!-- Print Area (A4 Page) -->
    <div id="printArea" class="bg-white mx-auto" style="width: 210mm;">
        <div id="ticketsContainer" class="grid grid-cols-4 gap-0 p-4">
            <!-- Tickets will be generated here -->
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script>
        let selectedClinic = null;
        let clinics = [];

        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.storage) {
                    resolve();
                } else {
                    setTimeout(() => waitForFirebase().then(resolve), 100);
                }
            });
        }

        // Load clinics
        async function loadClinics() {
            await waitForFirebase();
            try {
                const result = await window.storage.get('clinic-list');
                if (result && result.value) {
                    clinics = typeof result.value === 'string' ? JSON.parse(result.value) : result.value;
                    renderClinicButtons();
                    console.log('âœ… Clinics loaded:', clinics.length);
                }
            } catch (error) {
                console.error('Error loading clinics:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª');
            }
        }

        // Render clinic buttons
        function renderClinicButtons() {
            const container = document.getElementById('clinicButtons');
            container.innerHTML = '';
            
            if (clinics.length === 0) {
                container.innerHTML = '<p class="col-span-3 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹ÙŠØ§Ø¯Ø§Øª Ù…ØªØ§Ø­Ø©</p>';
                return;
            }

            clinics.forEach(clinic => {
                const button = document.createElement('button');
                button.className = 'bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg hover:from-blue-600 hover:to-blue-700 transition shadow-lg transform hover:scale-105';
                button.innerHTML = `
                    <div class="text-2xl font-bold mb-2">${clinic.name}</div>
                    <div class="text-lg">Ø¹ÙŠØ§Ø¯Ø© Ø±Ù‚Ù… ${clinic.number}</div>
                `;
                button.onclick = () => selectClinic(clinic);
                container.appendChild(button);
            });
        }

        // Select clinic
        function selectClinic(clinic) {
            selectedClinic = clinic;
            document.getElementById('printSettings').classList.remove('hidden');
            
            // Highlight selected
            const buttons = document.querySelectorAll('#clinicButtons button');
            buttons.forEach(btn => {
                btn.classList.remove('ring-4', 'ring-yellow-400');
            });
            event.target.closest('button').classList.add('ring-4', 'ring-yellow-400');
            
            console.log('âœ… Selected clinic:', clinic.name);
        }

        // Calculate wait time
        function calculateWaitTime(ticketNumber) {
            const waitingBefore = parseInt(document.getElementById('waitingCount').value) || 0;
            const avgTime = parseInt(document.getElementById('avgWaitTime').value) || 5;
            const position = ticketNumber + waitingBefore;
            const minutes = position * avgTime;
            
            if (minutes < 60) {
                return `${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours} Ø³Ø§Ø¹Ø©${mins > 0 ? ` Ùˆ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©` : ''}`;
            }
        }

        // Generate tickets
        function generateTickets() {
            if (!selectedClinic) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const start = parseInt(document.getElementById('startNumber').value);
            const end = parseInt(document.getElementById('endNumber').value);
            
            if (isNaN(start) || isNaN(end)) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©');
                return;
            }

            if (start > end) {
                alert('Ø±Ù‚Ù… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
                return;
            }

            if (end - start > 100) {
                if (!confirm('Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒØ«Ø± Ù…Ù† 100 ØªØ°ÙƒØ±Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                    return;
                }
            }

            const container = document.getElementById('ticketsContainer');
            container.innerHTML = '';

            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            for (let i = start; i <= end; i++) {
                const ticket = document.createElement('div');
                ticket.className = 'ticket flex flex-col justify-between p-3 bg-white';
                
                const waitTime = calculateWaitTime(i);
                const waitingBefore = parseInt(document.getElementById('waitingCount').value) || 0;
                
                ticket.innerHTML = `
                    <div class="text-center border-b-2 border-dashed pb-2 mb-2">
                        <div class="text-sm font-bold text-blue-800">${selectedClinic.name}</div>
                        <div class="text-xs text-gray-600">${currentDate}</div>
                    </div>
                    
                    <div class="flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-xs text-gray-600 mb-1">Ø±Ù‚Ù…Ùƒ</div>
                            <div class="text-6xl font-bold text-blue-900">${i}</div>
                        </div>
                    </div>
                    
                    <div class="text-center border-t-2 border-dashed pt-2 mt-2">
                        <div class="text-xs text-gray-700">
                            <div class="font-semibold mb-1">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                            <div class="text-blue-600 font-bold">${waitTime}</div>
                        </div>
                        ${waitingBefore > 0 ? `<div class="text-xs text-gray-600 mt-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ†: ${waitingBefore + i}</div>` : ''}
                    </div>
                    
                    <div class="text-center mt-2">
                        <div class="text-xs text-gray-500">Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù…Ø©</div>
                    </div>
                `;
                
                container.appendChild(ticket);
            }

            const count = end - start + 1;
            document.getElementById('ticketCount').textContent = count;
            document.getElementById('previewSection').classList.remove('hidden');
            
            console.log(`âœ… Generated ${count} tickets`);
        }

        // Print tickets
        function printTickets() {
            const container = document.getElementById('ticketsContainer');
            if (container.children.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            console.log('ğŸ–¨ï¸ Printing tickets...');
            window.print();
        }

        // Clear tickets
        function clearTickets() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ°Ø§ÙƒØ±ØŸ')) {
                document.getElementById('ticketsContainer').innerHTML = '';
                document.getElementById('previewSection').classList.add('hidden');
                console.log('âœ… Tickets cleared');
            }
        }

        // Initialize
        window.addEventListener('load', async () => {
            console.log('ğŸ–¨ï¸ Print page loaded');
            await loadClinics();
        });
    </script>
</body>
</html>
